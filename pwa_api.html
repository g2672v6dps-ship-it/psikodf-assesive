<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Push Notification API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .notification {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .timestamp {
            font-size: 0.8em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”” PWA Push Notification API</h1>
        
        <div class="status info">
            <strong>API Status:</strong> <span id="status">BaÅŸlatÄ±lÄ±yor...</span>
        </div>
        
        <div class="status info" id="browserInfo" style="margin-top: 10px;">
            <strong>TarayÄ±cÄ± Bilgileri:</strong> <span id="browserDetails">Analiz ediliyor...</span>
        </div>
        
        <h2>ğŸ“± Push Notification KayÄ±t</h2>
        <button onclick="registerPushNotifications()" id="registerBtn">
            ğŸ”” Push Notification Ä°zinlerini EtkinleÅŸtir
        </button>
        
        <h2>ğŸ§ª Test Bildirimi GÃ¶nder</h2>
        <button onclick="sendTestNotification()" id="testBtn">
            ğŸ“¤ Test Push Notification GÃ¶nder
        </button>
        
        <h2>ğŸ“Š AlÄ±nan Bildirimler</h2>
        <div id="notifications"></div>
    </div>

    <script>
        let registration = null;
        let notifications = [];

        // TarayÄ±cÄ± bilgilerini analiz et
        function analyzeBrowser() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isBrave = userAgent.includes('brave');
            const isOpera = userAgent.includes('opera') || userAgent.includes('opr');
            const isChrome = userAgent.includes('chrome') && !isOpera && !isBrave;
            const isEdge = userAgent.includes('edg');
            const isFirefox = userAgent.includes('firefox');
            const isSafari = userAgent.includes('safari') && !isChrome && !isBrave;
            
            let browserName = 'Bilinmiyor';
            let browserIcon = 'ğŸŒ';
            let supportStatus = 'unknown';
            let recommendations = [];
            
            if (isBrave) {
                browserName = 'Brave';
                browserIcon = 'ğŸ¦';
                recommendations.push('GÃ¼venlik ayarlarÄ±nÄ± kontrol edin');
            } else if (isOpera) {
                browserName = 'Opera';
                browserIcon = 'ğŸŸ ';
                recommendations.push('Bildirim izinlerini aÃ§Ä±n');
            } else if (isChrome) {
                browserName = 'Chrome';
                browserIcon = 'ğŸŸ¢';
                supportStatus = 'excellent';
            } else if (isEdge) {
                browserName = 'Edge';
                browserIcon = 'ğŸ”µ';
                supportStatus = 'good';
            } else if (isFirefox) {
                browserName = 'Firefox';
                browserIcon = 'ğŸ¦Š';
                supportStatus = 'limited';
                recommendations.push('Push API desteÄŸi sÄ±nÄ±rlÄ±');
            } else if (isSafari) {
                browserName = 'Safari';
                browserIcon = 'ğŸ§­';
                supportStatus = 'limited';
                recommendations.push('Sadece iOS/macOS');
            }
            
            // Push API desteÄŸini kontrol et
            const supportsPush = 'serviceWorker' in navigator && 'PushManager' in window;
            const supportsNotification = 'Notification' in window;
            
            let status = 'âŒ Desteklenmiyor';
            if (supportsPush && supportsNotification) {
                status = supportStatus === 'excellent' ? 'âœ… MÃ¼kemmel' : 
                        supportStatus === 'good' ? 'âœ… Ä°yi' : 'âš ï¸ SÄ±nÄ±rlÄ±';
            }
            
            let recommendationText = recommendations.length > 0 ? 
                '<br>ğŸ’¡ Ã–neri: ' + recommendations.join(', ') : '';
            
            document.getElementById('browserDetails').innerHTML = 
                `${browserIcon} ${browserName} - ${status}${recommendationText}`;
                
            return { browserName, isBrave, isOpera, isChrome, isEdge, supportsPush, supportsNotification };
        }

        // Fully Automated PWA ve Push Notification sistemi
        async function initialize() {
            try {
                console.log('ğŸ¤– Otomatik PWA Push Notification sistemi baÅŸlatÄ±lÄ±yor...');
                
                // TarayÄ±cÄ± analizi
                const browserInfo = analyzeBrowser();
                console.log('TarayÄ±cÄ± analizi tamamlandÄ±:', browserInfo);
                
                // TÃ¼m sistemi otomatik baÅŸlat
                await autoSetupEverything();
                
            } catch (error) {
                console.error('BaÅŸlatma hatasÄ±:', error);
                document.getElementById('status').innerHTML = 
                    '<span style="color: red;">âŒ Hata: ' + error.message + '</span>';
                showFallbackSetup();
            }
        }

        // TÃ¼m sistemi otomatik kur
        async function autoSetupEverything() {
            const browserInfo = analyzeBrowser();
            
            try {
                // 1. Service Worker kaydÄ±
                await setupServiceWorker();
                
                // 2. Push notification izni otomatik talep et
                await autoRequestNotificationPermission();
                
                // 3. PWA kurulumu otomatik hazÄ±rla
                await preparePWAInstallation();
                
                // 4. Test bildirimi gÃ¶nder
                await sendAutoWelcomeNotification();
                
                // 5. Kurulum durumunu gÃ¶ster
                updateSetupStatus('success', `ğŸ‰ Otomatik kurulum tamamlandÄ±! (${browserInfo.browserName})`);
                
            } catch (error) {
                console.error('Otomatik kurulum hatasÄ±:', error);
                updateSetupStatus('partial', `âš ï¸ KÄ±smi kurulum (${browserInfo.browserName})`);
                showManualHelp();
            }
        }

        // Service Worker otomatik kaydÄ±
        async function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                console.log('Service Worker kaydÄ± baÅŸlatÄ±lÄ±yor...');
                registration = await navigator.serviceWorker.register('/sw.js');
                console.log('âœ… Service Worker kaydedildi:', registration.scope);
                
                // Service Worker hazÄ±r olana kadar bekle
                await navigator.serviceWorker.ready;
                console.log('âœ… Service Worker hazÄ±r');
                
                return true;
            } else {
                throw new Error('Service Worker desteklenmiyor');
            }
        }

        // Otomatik notification permission talep et
        async function autoRequestNotificationPermission() {
            if (!('Notification' in window)) {
                throw new Error('Notification API desteklenmiyor');
            }

            const currentPermission = Notification.permission;
            console.log('Mevcut izin durumu:', currentPermission);
            
            if (currentPermission === 'granted') {
                console.log('âœ… Ä°zin zaten verilmiÅŸ');
                return true;
            } else if (currentPermission === 'denied') {
                throw new Error('Ä°zin reddedilmiÅŸ - manuel kurulum gerekli');
            } else {
                console.log('ğŸ”” Ä°zin talep ediliyor...');
                
                // Mobil kontrolÃ¼ - mobilde user gesture gerekir
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                if (isMobile || isIOS) {
                    console.log('ğŸ“± Mobil tarayÄ±cÄ± tespit edildi');
                    updateStatus('ğŸ“± Mobil kurulum gerekli - talimatlarÄ± takip edin');
                    return false;
                } else {
                    // Desktop iÃ§in otomatik izin
                    const permission = await Notification.requestPermission();
                    console.log('Ä°zin sonucu:', permission);
                    
                    if (permission === 'granted') {
                        console.log('âœ… Ä°zin verildi');
                        return true;
                    } else {
                        throw new Error('Ä°zin verilmedi');
                    }
                }
            }
        }

        // PWA kurulumu iÃ§in hazÄ±rlÄ±k
        async function preparePWAInstallation() {
            console.log('PWA kurulum hazÄ±rlÄ±ÄŸÄ± yapÄ±lÄ±yor...');
            
            // beforeinstallprompt event'ini dinle
            let deferredPrompt = null;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('PWA kurulum promptu yakalandÄ±');
                e.preventDefault();
                deferredPrompt = e;
                
                // 2 saniye sonra otomatik kurulum Ã¶ner
                setTimeout(() => {
                    if (deferredPrompt) {
                        showAutoInstallPrompt(deferredPrompt);
                    }
                }, 2000);
            });
            
            return true;
        }

        // Otomatik kurulum Ã¶neri gÃ¶ster
        async function showAutoInstallPrompt(deferredPrompt) {
            try {
                console.log('Otomatik kurulum Ã¶nerisi gÃ¶steriliyor...');
                
                // KullanÄ±cÄ± dostu mesaj
                const userConfirmed = confirm(
                    'ğŸ“± YKS Takip uygulamasÄ±nÄ± ana ekranÄ±nÄ±za eklemek ister misiniz?\\n\\n' +
                    'âœ… Bildirimleri daha iyi alabileceksiniz\\n' +
                    'âœ… Ä°nternet olmadan da Ã§alÄ±ÅŸÄ±r\\n' +
                    'âœ… Daha hÄ±zlÄ± eriÅŸim saÄŸlar'
                );
                
                if (userConfirmed) {
                    deferredPrompt.prompt();
                    const choiceResult = await deferredPrompt.userChoice;
                    
                    if (choiceResult.outcome === 'accepted') {
                        console.log('âœ… KullanÄ±cÄ± PWA kurulumunu kabul etti');
                        alert('ğŸ‰ PWA baÅŸarÄ±yla kuruldu! Ana ekranÄ±nÄ±zda ğŸ¯ ikonunu gÃ¶receksiniz.');
                    } else {
                        console.log('âŒ KullanÄ±cÄ± PWA kurulumunu reddetti');
                    }
                }
                
                deferredPrompt = null;
            } catch (error) {
                console.error('PWA kurulum hatasÄ±:', error);
            }
        }

        // Otomatik hoÅŸgeldin bildirimi
        async function sendAutoWelcomeNotification() {
            try {
                const browserInfo = analyzeBrowser();
                const notification = new Notification('ğŸ‰ YKS Takip HazÄ±r!', {
                    body: `HoÅŸgeldin! Bildirimlerinizi alabilmek iÃ§in sistem kuruldu. (${browserInfo.browserName})`,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%233B82F6"/><text x="50" y="60" font-size="40" text-anchor="middle" fill="white">ğŸ¯</text></svg>',
                    tag: 'auto_welcome',
                    requireInteraction: false,
                    silent: false
                });
                
                console.log('âœ… HoÅŸgeldin bildirimi gÃ¶nderildi');
                
                // 3 saniye sonra bildirimi kapat
                setTimeout(() => notification.close(), 3000);
                
            } catch (error) {
                console.error('HoÅŸgeldin bildirimi hatasÄ±:', error);
            }
        }

        // Kurulum durumunu gÃ¼ncelle
        function updateSetupStatus(type, message) {
            const statusEl = document.getElementById('status');
            let style = 'color: green;';
            
            if (type === 'partial') {
                style = 'color: orange;';
            } else if (type === 'error') {
                style = 'color: red;';
            }
            
            statusEl.innerHTML = `<span style="${style}">${message}</span>`;
        }

        // Fallback sistem gÃ¶ster
        function showFallbackSetup() {
            document.getElementById('status').innerHTML = 
                '<span style="color: red;">âš ï¸ Manuel kurulum gerekli</span>';
        }

        // Manuel yardÄ±m gÃ¶ster
        function showManualHelp() {
            setTimeout(() => {
                alert(
                    'ğŸ”§ Manuel Kurulum Gerekli:\\n\\n' +
                    '1. Adres Ã§ubuÄŸundaki + simgesine tÄ±kla\\n' +
                    '2. "Ana ekrana ekle" seÃ§\\n' +
                    '3. Bildirim izinlerini ver\\n\\n' +
                    'ğŸ’¡ Bu iÅŸlemler sadece bir kez gerekli!'
                );
            }, 1000);
        }

        // Enhanced Push notification iÃ§in izin al
        async function registerPushNotifications() {
            try {
                // TarayÄ±cÄ± tÃ¼rÃ¼nÃ¼ tespit et
                const userAgent = navigator.userAgent.toLowerCase();
                const isBrave = userAgent.includes('brave');
                const isOpera = userAgent.includes('opera') || userAgent.includes('opr');
                const isChrome = userAgent.includes('chrome') && !isOpera;
                const isEdge = userAgent.includes('edg');
                
                console.log('TarayÄ±cÄ± analizi:', { isBrave, isOpera, isChrome, isEdge, userAgent: navigator.userAgent });
                
                // Notification API desteÄŸini kontrol et
                if (!('Notification' in window)) {
                    showBrowserSupportMessage('Bu tarayÄ±cÄ± bildirimleri desteklemiyor', isBrave, isOpera);
                    return;
                }
                
                const permission = Notification.permission;
                console.log('Ä°zin durumu:', permission);
                
                if (permission === 'granted') {
                    // Test notification gÃ¶ster
                    const browserName = isBrave ? 'Brave' : isOpera ? 'Opera' : isChrome ? 'Chrome' : isEdge ? 'Edge' : 'Bilinmiyor';
                    
                    new Notification('ğŸ‰ Push Notification HazÄ±r!', {
                        body: `Bildirim sistemi baÅŸarÄ±yla kuruldu (${browserName})`,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ¯</text></svg>',
                        tag: 'push_ready',
                        requireInteraction: true
                    });
                    
                    document.getElementById('status').innerHTML = 
                        `<span style="color: green;">âœ… Push Notification Etkin (${browserName})</span>`;
                        
                } else if (permission === 'denied') {
                    const browserName = isBrave ? 'Brave' : isOpera ? 'Opera' : 'TarayÄ±cÄ±nÄ±z';
                    alert(`âŒ Bildirim izni reddedilmiÅŸ (${browserName})!\\n\\nğŸ”§ Ã‡Ã¶zÃ¼m AdÄ±mlarÄ±:\\n1. TarayÄ±cÄ± ayarlarÄ±nÄ± aÃ§\\n2. Ä°zinler/Bildirimler bÃ¶lÃ¼mÃ¼ne git\\n3. Bu site iÃ§in izin ver\\n4. SayfayÄ± yenile`);
                    
                } else {
                    // Ä°zin iste
                    Notification.requestPermission().then(function(permission) {
                        if (permission === 'granted') {
                            registerPushNotifications(); // Recursive call
                        } else {
                            const browserName = isBrave ? 'Brave' : isOpera ? 'Opera' : 'TarayÄ±cÄ±nÄ±z';
                            alert(`âŒ ${browserName} bildirim iznini reddetti!\\n\\nğŸ”§ Manuel Ã‡Ã¶zÃ¼m:\\nâ€¢ Adres Ã§ubuÄŸundaki ğŸ”’ simgesine tÄ±kla\\nâ€¢ Bildirim > Ä°zin Ver seÃ§\\nâ€¢ SayfayÄ± yenile`);
                        }
                    });
                }
            } catch (error) {
                console.error('Push notification kayÄ±t hatasÄ±:', error);
                alert('âŒ Push notification kurulum hatasÄ±: ' + error.message);
            }
        }
        
        // TarayÄ±cÄ± destek mesajÄ± gÃ¶ster
        function showBrowserSupportMessage(message, isBrave, isOpera) {
            const browserName = isBrave ? 'Brave' : isOpera ? 'Opera' : 'TarayÄ±cÄ±nÄ±z';
            let solution = '';
            
            if (isBrave) {
                solution = '\\n\\nğŸ”§ Brave iÃ§in:\\n1. brave://settings/content/notifications\\n2. "Ä°zin Ver" seÃ§\\n3. Bu siteyi ekle\\n4. SayfayÄ± yenile';
            } else if (isOpera) {
                solution = '\\n\\nğŸ”§ Opera iÃ§in:\\n1. opera://settings/content/notifications\\n2. "TÃ¼m sitelerden bildirimlere izin ver" veya\\n3. Bu site iÃ§in Ã¶zel izin ver\\n4. SayfayÄ± yenile';
            } else {
                solution = '\\n\\nğŸ”§ Genel Ã‡Ã¶zÃ¼m:\\nâ€¢ Chrome veya Edge kullanmayÄ± deneyin\\nâ€¢ TarayÄ±cÄ± gÃ¼ncellemesi yapÄ±n\\nâ€¢ HTTPS kullanÄ±ldÄ±ÄŸÄ±ndan emin olun';
            }
            
            alert(`âŒ ${message} (${browserName})${solution}`);
        }

        // Enhanced Test push notification gÃ¶nder
        async function sendTestNotification() {
            try {
                // TarayÄ±cÄ± tÃ¼rÃ¼nÃ¼ tespit et
                const userAgent = navigator.userAgent.toLowerCase();
                const isBrave = userAgent.includes('brave');
                const isOpera = userAgent.includes('opera') || userAgent.includes('opr');
                const browserName = isBrave ? 'Brave' : isOpera ? 'Opera' : 'TarayÄ±cÄ±nÄ±z';
                
                // Notification API kontrolÃ¼
                if (!('Notification' in window)) {
                    alert(`âŒ ${browserName} bildirimleri desteklemiyor!\\n\\nğŸ”§ Alternatif:\\nâ€¢ Chrome veya Edge kullanÄ±n\\nâ€¢ Brave ayarlarÄ±ndan bildirimleri aÃ§Ä±n`);
                    return;
                }
                
                if (Notification.permission !== 'granted') {
                    alert(`âŒ ${browserName} bildirim izni yok!\\n\\nğŸ”§ Ã–nce izin al:\\nâ€¢ "Push Notification Ä°zinlerini EtkinleÅŸtir" butonuna tÄ±kla`);
                    return;
                }
                
                // Test notification gÃ¶nder
                const notification = new Notification('ğŸ§ª Test Bildirimi', {
                    body: `PWA push notification sistemi Ã§alÄ±ÅŸÄ±yor! (${browserName})`,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ””</text></svg>',
                    tag: 'test_notification',
                    requireInteraction: true
                });

                // Bildirim geÃ§miÅŸine ekle
                addToHistory('Test Bildirimi', `PWA push notification sistemi Ã§alÄ±ÅŸÄ±yor! (${browserName})`, 'test');
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
                
                // 5 saniye sonra kapat
                setTimeout(() => notification.close(), 5000);
                
                alert(`âœ… ${browserName} test bildirimi baÅŸarÄ±yla gÃ¶nderildi!`);
                
            } catch (error) {
                console.error('Test notification hatasÄ±:', error);
                alert(`âŒ Test notification gÃ¶nderilemedi: ${error.message}\\n\\nğŸ”§ Ã‡Ã¶zÃ¼m:\\nâ€¢ TarayÄ±cÄ± izinlerini kontrol edin\\nâ€¢ SayfayÄ± yenileyin\\nâ€¢ FarklÄ± tarayÄ±cÄ± deneyin`);
            }
        }

        // Bildirim geÃ§miÅŸine ekle
        function addToHistory(title, message, type) {
            const notification = {
                title: title,
                message: message,
                type: type,
                timestamp: new Date().toLocaleString('tr-TR')
            };
            
            notifications.unshift(notification);
            displayNotifications();
        }

        // Bildirimleri gÃ¶rÃ¼ntÃ¼le
        function displayNotifications() {
            const container = document.getElementById('notifications');
            
            if (notifications.length === 0) {
                container.innerHTML = '<p>HenÃ¼z bildirim alÄ±nmadÄ±.</p>';
                return;
            }
            
            let html = '';
            notifications.forEach((notif, index) => {
                html += `
                    <div class="notification">
                        <strong>${notif.title}</strong><br>
                        ${notif.message}<br>
                        <span class="timestamp">${notif.timestamp} - ${notif.type}</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Service Worker'dan gelen push eventlerini dinle
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                console.log('SW mesajÄ± alÄ±ndÄ±:', event.data);
                
                if (event.data && event.data.type === 'push_notification') {
                    addToHistory(
                        event.data.title, 
                        event.data.body, 
                        event.data.tag || 'push'
                    );
                }
            });
        }

        // API endpoint simÃ¼lasyonu
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'api_notification') {
                addToHistory(
                    event.data.title, 
                    event.data.body, 
                    event.data.tag || 'api'
                );
            }
        });

        // Sayfa yÃ¼klendiÄŸinde baÅŸlat
        window.addEventListener('load', initialize);
        
        // Debug iÃ§in
        window.debugPushNotifications = {
            registration: () => registration,
            permissions: () => Notification.permission,
            notifications: () => notifications,
            clearHistory: () => {
                notifications = [];
                displayNotifications();
            }
        };
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9a761d7c988bc126","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"e72945439c264b3b85d2e3b689102d27"}' crossorigin="anonymous"></script>
</body>
</html>